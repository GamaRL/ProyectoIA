@page "/algorithms/regression"

@inject IUploadFileService UploadFileServ;
@inject ILogisticRegressionService RegressionServ;

<Container Fluid Margin="Margin.Is5.FromBottom">
   <h1>Algorithm usage</h1>
   <Row>
     <Column ColumnSize="ColumnSize.Is6.OnDesktop.Is12">
       <Div>
         <Field>
           <Select TValue="int" SelectedValueChanged="OnSelectedFileChanged">
             @foreach (var file in uploadedFiles)
            {
              <SelectItem Value="@file.Id">@file.Id - @file.Name</SelectItem>
            }
          </Select>
        </Field>
      </Div>
    </Column>
    <Column ColumnSize="ColumnSize.Is6.OnTablet.Is12">
      <Buttons>
        <Button Clicked="@ShowConfigModal" Color="Color.Success"
          Size="Size.Small" Disabled="somethingWentWrong">Configuration</Button>
        <Button Clicked="@ShowFeaturesModal" Color="Color.Info"
          Size="Size.Small" Disabled="somethingWentWrong">Dimensions</Button>
      </Buttons>
    </Column>
  </Row>
</Container>

<Modal @ref="configModalRef">
  <ModalContent Centered Scrollable Size="ModalSize.ExtraLarge">
     <ModalHeader>
       <ModalTitle>Training Parameters</ModalTitle>
       <CloseButton />
     </ModalHeader>
     <ModalBody>
       <Container>
         <h2>Predictor variables</h2>
         <Row>
           <Column>
             <Check TValue="bool" Checked="@containsHeaders"
               CheckedChanged="@OnContainsHeadersChanged">
               Use first row as columns' name?
             </Check>
           </Column>
         </Row>
         <Row Margin="Margin.Is4.FromTop">
           @foreach (var item in predictorHeaders)
          {
            <Column ColumnSize="ColumnSize.Is2.OnDesktop.Is12">
              <Check TValue="bool" Checked="@item.IsSelected"
                CheckedChanged="(value) => OnCheckedChanged(item, value)">
                @item.Header</Check>
            </Column>
          }
        </Row>
        <Divider DividerType="DividerType.Dotted" />
        <h2>Class variable</h2>
        <RadioGroup TValue="HeaderSelection" Name="classHeaders"
          CheckedValue="classVariable" CheckedValueChanged="OnRadioChanged">
          <Row Margin="Margin.Is4.FromTop">
            @if (classHeaders.Count > 0)
            {
              @foreach (var item in classHeaders)
              {
                <Column ColumnSize="ColumnSize.Is2.OnDesktop.Is12">
                  <Radio Value="@item">@item.Header</Radio>
                </Column>
              }
            }
            else
            {
              <Column ColumnSize="ColumnSize.Is12.OnDesktop.Is12">
                <Alert Color="Color.Warning" Visible>
                <AlertMessage>Warning</AlertMessage>
                  <AlertDescription>You must select a class variable
                  </AlertDescription>
                </Alert>
              </Column>
            }
          </Row>
        </RadioGroup>
        <Divider DividerType="DividerType.Dotted" />
        <h2>Additional Options</h2>
        <Row Margin="Margin.Is4.FromTop">
          <Column>
            <Label>Shuffle</Label>
            <RadioGroup TValue="bool" Name="shuffle"
              @bind-CheckedValue="@shuffle">
              <Radio Value="true">Yes</Radio>
              <Radio Value="false">No</Radio>
            </RadioGroup>
          </Column>
        </Row>
        <Row Margin="Margin.Is4.FromTop">
          <Column>
            <Label>Test Size (@testSize %)</Label>
            <Field>
              <Slider @bind-Value="@testSize" Step="1" TValue="float" Min="0" Max="100"/>
            </Field>
          </Column>
        </Row>
      </Container>
    </ModalBody>
    <ModalFooter>
      <Button Color="Color.Secondary" Clicked="@SaveConfig">Train model</Button>
      <Button Color="Color.Danger" Clicked="@HideConfigModal">Close</Button>
    </ModalFooter>
  </ModalContent>
</Modal>

<Modal @ref="featuresModalRef">
  <ModalContent Centered Scrollable Size="ModalSize.ExtraLarge">
     <ModalHeader>
       <ModalTitle>Dimensionality Reduction</ModalTitle>
       <CloseButton />
     </ModalHeader>
     <ModalBody>
       <Tabs SelectedTab="@selectedTab"
         SelectedTabChanged="@OnSelectedTabChanged">
         <Items>
           <Tab Name="corr">Correlation</Tab>
           <Tab Name="pca">PCA</Tab>
         </Items>
         <Content>
           <TabPanel Name="corr">
             <Container Fluid Margin="Margin.Is4.FromTop">
               <h3>Correlation Analysis</h3>
               @if (correlationAnalysis != null &&
              correlationAnalysis.StrongCorrelations.Count > 0)
              {
                <Alert Color="Color.Warning" Visible>
                 <AlertMessage>Strong correlations were found</AlertMessage>
                 <AlertDescription>
                   <ul>
                     @foreach (var item in
                     correlationAnalysis.StrongCorrelations)
                      {
                        <li>@item[0] - @item[1]</li>
                      }
                    </ul>
                  </AlertDescription>
                </Alert>
              }
              else
              {
                <Alert Color="Color.Success" Visible>
                 <AlertMessage>No strong correlations were found</AlertMessage>
                 <AlertDescription>
                   You can continue!
                 </AlertDescription>
               </Alert>
              }
              <Row>
                <img src="@mapUrl" alt="Loading..." class="img-fluid">
              </Row>
            </Container>
          </TabPanel>
          <TabPanel Name="pca">
            <Container>
              <h3>Pricipal Component Analysis</h3>
            </Container>
          </TabPanel>
        </Content>
      </Tabs>
    </ModalBody>
    <ModalFooter>
      <Button Color="Color.Danger" Clicked="@HideFeaturesModal">Close</Button>
    </ModalFooter>
  </ModalContent>
</Modal>

@code {

  private Modal configModalRef = new();
  private Modal featuresModalRef = new();
  private float testSize = 1;
  private bool shuffle = false;
  private string selectedTab = "corr";
  private string mapUrl = "";
  private CorrelationAnalysisResponse correlationAnalysis = null;
  private List<FileModel> uploadedFiles = new();
  private HeaderSelection classVariable;
  private int selectedFileId;
  private List<HeaderSelection> predictorHeaders = new();
  private List<HeaderSelection> classHeaders = new();
  private bool containsHeaders = true;
  private bool somethingWentWrong;

  protected override async Task OnInitializedAsync()
  {
    await base.OnInitializedAsync();

    this.uploadedFiles.AddRange(await
    UploadFileServ.GetFiles(AlgorithmType.LOGISTIC_REGRESSION));
    selectedFileId = this.uploadedFiles.First().Id;

    await GetHeaders();
    await OnUpdateParams();
    StateHasChanged();
  }

  public async Task GetHeaders()
  {
    var data = await UploadFileServ.GetFileHeaders(selectedFileId, containsHeaders,
    AlgorithmType.LOGISTIC_REGRESSION);

    predictorHeaders.Clear();
    foreach (var header in data)
      predictorHeaders.Add(new HeaderSelection(header));
  }

  public async void OnSelectedFileChanged(int value)
  {
    selectedFileId = value;
    await GetHeaders();
    await OnUpdateParams();
    StateHasChanged();
  }

  public async Task OnUpdateParams()
  {
    var cols = predictorHeaders
    .Where<HeaderSelection>(h => h.IsSelected)
    .Select<HeaderSelection, object>(h => h.Header).ToList();
    try
    {
      somethingWentWrong = false;
      this.correlationAnalysis = await
      RegressionServ.GetCorrelationAnalysis(selectedFileId, containsHeaders);
      this.mapUrl = RegressionServ.GetImageUrl(this.correlationAnalysis.MapFileName);
    }
    catch (HttpRequestException ex)
    {
      if (ex.StatusCode == System.Net.HttpStatusCode.BadRequest)
      {
        this.correlationAnalysis = null;
        this.mapUrl = "";
        somethingWentWrong = true;
      }
    }
  }

  public async Task OnCheckedChanged(HeaderSelection headerSelection, bool value)
  {
    headerSelection.IsSelected = value;

    classHeaders = predictorHeaders
    .Where<HeaderSelection>(h => !h.IsSelected)
    .ToList();

    if (!classHeaders.Contains(classVariable) || classVariable == null)
    {
      classVariable = classHeaders.First();
    }
    await OnUpdateParams();
    StateHasChanged();
  }

  public async Task OnRadioChanged(HeaderSelection value)
  {
    classVariable = value;
    await OnUpdateParams();
    StateHasChanged();
  }

  public async void OnContainsHeadersChanged(bool value)
  {
    containsHeaders = value;
    predictorHeaders.Clear();
    await GetHeaders();
    Console.WriteLine(predictorHeaders.Count);
    if (predictorHeaders.Count > 0)
    {
      await OnUpdateParams();
    }
    else
    {
      somethingWentWrong = true;
    }
    StateHasChanged();
  }
  private void ShowFeaturesModal()
  {
    featuresModalRef.Show();
  }

  private void HideFeaturesModal()
  {
    featuresModalRef.Hide();
  }

  private async void ShowConfigModal()
  {
    RegressionSettingsData data;
    
    try {
      data = await RegressionServ.GetRegressionSettingsData(selectedFileId);
      shuffle = data.Shuffle;
      @* classVariable = data.ClassVariable; *@
      @* predictorHeaders.ForEach(p => {
        if (data.PredictorVariables.Contains(p.Header))
          p.IsSelected = true;
        else
          p.IsSelected = false;
      }); *@

    } catch(HttpRequestException ex) {
    }
    await configModalRef.Show();
  }

  private async void SaveConfig()
  {
    RegressionSettingsData settings = new();
    settings.ClassVariable = classVariable.Header;
    settings.ContainsHeaders = containsHeaders;
    settings.FileId = selectedFileId;
    settings.TestSize = testSize / 100;
    settings.Shuffle = shuffle;
    settings.PredictorVariables = predictorHeaders
    .Where<HeaderSelection>(h => h.IsSelected)
    .Select<HeaderSelection, object>(h => h.Header).ToList();

    await RegressionServ.SaveRegressionSettingsData(settings);
  }

  private void HideConfigModal()
  {
    configModalRef.Hide();
  }

  private void OnSelectedTabChanged(string name)
  {
    selectedTab = name;
  }
}